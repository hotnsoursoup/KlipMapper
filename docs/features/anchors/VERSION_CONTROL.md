# Detached Anchor System - Version Control Strategy

**Status:** Draft / Proposed  
**Date:** 2026-01-28

## Goals

- Keep git diffs readable and avoid source code pollution.
- Ensure anchor files can be safely regenerated.
- Prevent noisy merge conflicts or accidental data loss.

## Recommended Default

**Treat anchor files as derived artifacts** and **ignore by default**.

- `.agentmap/` should be added to `.gitignore` by default.
- Anchors can be regenerated by the daemon or CLI.

## Optional Strategies (Team Choice)

### 1) Commit Skeleton Only

**Pros**: fast navigation without daemon; cache for CI/CD.
**Cons**: frequent diffs, still possible merge conflicts.

### 2) Commit Skeleton + Semantic

**Pros**: stable semantics in code reviews; shared enrichment.
**Cons**: highest noise, re-enrichment conflicts, model drift.

### 3) Commit No Anchors (Default)

**Pros**: clean repo; no merge conflicts; easy upgrades.
**Cons**: requires local daemon or build step.

## Git Hygiene Recommendations

- **Ignore patterns** (default):
  - `.agentmap/anchors/`
  - `.agentmap/cache/`
- **Keep**: `.agentmap/policy.md` (if policy is part of the repo).
- Consider **.gitattributes** for JSON diff drivers if anchors are committed.
- Avoid LFS unless anchors are extremely large or binary.

## Merge & Conflict Strategy (If Committed)

- Prefer “ours” on semantic anchors and re-enrich after merge.
- Prefer “theirs” on skeleton anchors if file was modified in the branch.
- Provide a `agentmap anchors rebuild` command to normalize state post-merge.

## Upgrade & Migration Policy

- On schema version change, the daemon should **invalidate and rebuild** anchors.
- If anchors are committed, document the upgrade in `CHANGELOG.md` and provide migration tooling.

## Open Decisions

- Should `agentmap init` modify `.gitignore` by default?
- Should we provide a repo-level opt-in to commit anchors?
- How to store per-branch vs per-worktree anchors when multiple branches are active?
